<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Voting</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.firebasestorage.app",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

let db, auth, userId;
let visitorId = null;
let selectedVoteId = null;
let selectedVoteName = "";
let selectedVoteImage = "";
let appInitialized = false;
let votingEnabled = true;

/* Performer Data */
const performerData = {
  option1: { name: "Below", img: "https://i.imgur.com/DIyK2zX.jpeg" },
  option2: { name: "Deliverance", img: "https://i.imgur.com/s7Unz9r.jpeg" },
  option3: { name: "Mask Off", img: "https://i.imgur.com/x0BI8Mc.jpeg" },
  option4: { name: "Metro Motion", img: "https://i.imgur.com/4rG47gL.jpeg" },
  option5: { name: "Sin Games", img: "https://i.imgur.com/k75mMUz.jpeg" },
  option6: { name: "Anonymity", img: "https://i.imgur.com/3dJQFeX.jpeg" },
};

/* Geofences */
const geofences = [
  { minLat: 33.508268, maxLat: 33.511748, minLong: -112.130755, maxLong: -112.126984 },
  { minLat: 33.512279, maxLat: 33.512623, minLong: -112.130699, maxLong: -112.130440 },
  { minLat: 33.6786695, maxLat: 33.6789695, minLong: -112.256548, maxLong: -112.256248 }
];

/* DOM Elements */
let locationError, locationButton, performersContainer, submitVoteButton, confirmationMessage, confirmationImage;

document.addEventListener("DOMContentLoaded", () => {
  locationError = document.getElementById("location-error");
  locationButton = document.getElementById("location-btn");
  performersContainer = document.getElementById("performers-container");
  submitVoteButton = document.getElementById("submit-vote-btn");
  confirmationMessage = document.getElementById("confirmation-message");
  confirmationImage = document.getElementById("confirmation-image");
});

function setScreen(id) {
  document.querySelectorAll(".screen").forEach(el => el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function isInsideGeofence(lat, long) {
  return geofences.some(({ minLat, maxLat, minLong, maxLong }) =>
    lat >= minLat && lat <= maxLat && long >= minLong && long <= maxLong
  );
}

function setLoading(isLoading, message = "Verifying your location...") {
  locationButton.disabled = isLoading;
  if (isLoading) {
    locationButton.classList.remove("glow");
    locationButton.innerHTML = '<div class="spinner mx-auto"></div>';
    locationError.textContent = message;
  } else {
    locationButton.classList.add("glow");
    locationButton.innerHTML = "<span>Begin Voting</span>";
  }
}

function showError(msg) {
  setLoading(false);
  locationError.textContent = msg;
  locationError.classList.add("text-red-400", "font-bold");
}

/* Restore existing vote on refresh */
async function restoreVoteIfExists() {
  if (!visitorId) return;
  const snap = await getDoc(doc(db, "lip_sync_2025_votes", visitorId));
  if (snap.exists()) {
    const { voteId } = snap.data();
    if (performerData[voteId]) {
      const performer = performerData[voteId];
      confirmationImage.src = performer.img;
      confirmationMessage.innerHTML = `
        Your vote for <b>${performer.name}</b> has been recorded.<br><br>
        Thank you for attending <b>Lip Sync: For Good!</b>
      `;
      setScreen("confirmation-screen");
    }
  }
}

/* Card Selection */
function handleCardSelection(e) {
  const card = e.target.closest(".performer-card");
  if (!card || !votingEnabled) return;
  document.querySelectorAll(".performer-card").forEach(c => c.classList.remove("selected"));
  card.classList.add("selected");
  selectedVoteId = card.dataset.voteId;
  selectedVoteName = card.querySelector("h4").textContent;
  selectedVoteImage = card.querySelector("img").src;

  submitVoteButton.disabled = false;
  submitVoteButton.textContent = `Submit Vote for ${selectedVoteName}`;
  submitVoteButton.classList.add("ready");
}

/* Submit Vote */
async function submitVote(voteId, btn) {
  if (!visitorId) return showError("Fingerprint not ready.");
  if (!votingEnabled) return showError("Voting is currently disabled.");

  btn.disabled = true;
  btn.textContent = "Submitting...";

  try {
    await setDoc(doc(db, "lip_sync_2025_votes", visitorId), {
      voteId,
      createdAt: Date.now(),
      userId,
      fingerprint: visitorId,
      userAgent: navigator.userAgent
    });

    confirmationImage.src = selectedVoteImage;
    confirmationMessage.innerHTML = `
      Your vote for <b>${selectedVoteName}</b> has been recorded.<br><br>
      Thank you for attending <b>Lip Sync: For Good!</b>
    `;
    setScreen("confirmation-screen");
  } catch (e) {
    btn.disabled = false;
    btn.textContent = "Vote Failed – Retry";
    showError("Error saving vote.");
  }
}

/* Location Check */
async function handleLocationCheck() {
  if (!navigator.geolocation) return showError("Your device does not support location access.");
  if (!votingEnabled) return showError("Voting is currently closed.");

  setLoading(true, "Checking your location…");
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      if (isInsideGeofence(latitude, longitude)) {
        setLoading(false);
        setScreen("voting-screen");
      } else showError("You must be within the event area to vote.");
    },
    err => showError("Location access is required to vote."),
    { timeout: 10000 }
  );
}

/* Initialize */
function initApp() {
  FingerprintJS.load()
    .then(fp => fp.get())
    .then(async r => {
      visitorId = r.visitorId;
      locationButton.disabled = false;
      locationButton.classList.add("glow");
      await restoreVoteIfExists(); // restore previous vote
    })
    .catch(() => showError("Unable to verify identity. Please refresh."));

  locationButton.addEventListener("click", handleLocationCheck);
  performersContainer.addEventListener("click", handleCardSelection);
  submitVoteButton.addEventListener("click", () => submitVote(selectedVoteId, submitVoteButton));

  const settingsRef = doc(db, "lip_sync_2025_settings", "state");
  onSnapshot(settingsRef, (snap) => {
    if (snap.exists()) votingEnabled = snap.data().enabled;
  });
}

/* Firebase Init */
const app = initializeApp(firebaseConfig);

/* ✅ Firebase App Check (reCAPTCHA v3) */
const appCheck = initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),
  isTokenAutoRefreshEnabled: true
});

db = getFirestore(app);
auth = getAuth(app);
onAuthStateChanged(auth, u => {
  if (u) {
    userId = u.uid;
    if (!appInitialized) {
      appInitialized = true;
      initApp();
    }
  }
});
signInAnonymously(auth).catch(console.error);
</script>
